#!/usr/bin/perl
use lib qw(/opt/w5base2/lib /opt/w5base/lib);
use strict;                   
use W5Base::API;
use LWP::UserAgent;
use HTTP::Request::Common;
use HTTP::Cookies;
use HTML::Parser;
use Data::Dumper;


my $DefaultBase="http://ibest.t-systems.com/ibest";
my ($help,$verbose,$loginuser,$loginpass,$quiet,$base,$lang);
my %P=("help"=>\$help,"base=s"=>\$base,"lang=s"=>\$lang,
       "webuser=s"=>\$loginuser,"webpass=s"=> \$loginpass,
       "verbose+"=>\$verbose);
my $optresult=XGetOptions(\%P,\&Help,undef,undef,".iBest");
$base=$DefaultBase if (!defined($base));

######################################################################
#
# Init UserAgent
#
my $ua=new LWP::UserAgent(env_proxy=>1);
$ua->cookie_jar(HTTP::Cookies->new(file => "$ENV{HOME}/.cookies.txt"));
$ua->timeout(60);

######################################################################
#
# Init Form Parser
#
my %form;
my @cid;
my %checkbox;
my $html=new HTML::Parser();
$html->handler(start=>sub {
                         my ($self,$tag,$attr)=@_;
                         if (lc($tag) eq "input"){
                           # if ($attr->{name} eq "CID"){
                           #    push(@cid,$attr->{value});
                           # }
                           # else{
                               $form{$attr->{name}}=$attr->{value};
                           # }
                         }
                      },'self, tagname, attr');
######################################################################


printf("INFO:  starting login as '%s'\n",$loginuser) if ($verbose);
my $pageurl=$base."/firewall_firewall/login";
my $response=$ua->request(GET($pageurl));
if ($response->code ne "200"){
   printf STDERR ("ERROR: fail to get '%s'\n",$pageurl);
   exit(1);
}
eval('$html->parse($response->content);');
if ($@ ne ""){
   printf STDERR ("%s\n",$@);
   printf STDERR ("ERROR: parsing loginurl\n");
   exit(1);
}
#print $response->content();

$form{username}=$loginuser;
$form{password}=$loginpass;
#
#print Dumper(\%form);

my $req=POST($pageurl,Content_Type=>'form-data',Content=>[%form]);

my $response=$ua->request($req);
if ($response->code ne "200"){
   printf STDERR ("ERROR: fail to login as '%s'\n",$loginuser);
   print STDERR $response->code;
   print STDERR $response->content;
   exit(1);
}
my $page=$response->content();

if ($page=~m/Anmeldung fehlgeschlagen/){
   printf STDERR ("ERROR: login failed\n");
   exit(1);
}
printf("INFO:  login as '%s' OK\n",$loginuser) if ($verbose);

#print $response->content();

######################################################################
# IP eintragen
######################################################################
my @ipl=qw(164.29.128.75 164.29.24.206 164.28.242.19 164.26.243.143 164.30.209.12 10.118.44.51 10.118.65.65 10.118.36.56 164.25.186.160 164.25.87.24 164.24.223.215 164.22.149.11 164.26.193.82 164.25.244.139 10.132.239.163 164.20.37.14 164.24.18.76 164.24.110.87 164.18.34.12 10.208.30.30 164.25.123.108 10.94.54.158 164.21.142.206 164.21.142.225 164.24.37.217 164.16.64.207 164.28.118.26 164.16.140.76 164.30.224.203 164.18.44.170 10.81.81.72 164.30.47.81 10.92.63.147 10.82.154.98 164.32.118.94 164.33.140.38 164.28.193.67 10.203.26.181 10.187.160.38 164.28.197.58 164.24.20.241 10.174.153.22 164.18.51.139 164.22.4.147 10.141.94.55 164.29.59.162 10.108.35.207 10.108.35.205 10.153.247.26 10.82.180.142 10.118.38.105 164.29.59.163 10.82.51.12 10.208.17.11 10.186.30.27 164.23.92.213 164.24.84.80 164.30.42.244 164.26.176.159 10.160.81.79 164.26.164.14 164.26.26.19 164.22.22.47 164.29.48.140 10.94.20.58 164.21.152.76 164.21.160.12 164.16.208.92 164.27.26.29 164.26.151.150 10.82.41.23 164.24.210.88 164.33.120.75 164.16.192.39 164.23.164.11 164.18.16.12 164.30.25.184 164.24.11.45 10.208.17.12 164.23.212.103 10.123.22.18 164.26.64.154 164.24.37.140 10.108.35.197 164.26.36.11 10.94.71.120 10.94.68.63 164.32.65.84 10.121.86.120 164.20.167.15 164.20.167.18 164.26.128.22 10.124.20.32 164.32.184.94 164.34.227.56 164.30.39.142 164.22.10.20 164.23.38.35 164.23.255.144 164.18.136.231 164.24.213.32 10.123.32.133 164.34.51.14 10.118.65.227 164.25.174.95 164.34.227.55 164.30.28.211 10.141.155.57 164.30.10.132 10.94.30.77 164.23.182.148 164.26.148.219 164.33.66.28 160.44.150.203 164.20.203.211 164.28.81.16 164.24.226.155 10.187.30.103 164.22.225.53 164.21.142.229 164.23.78.91 164.22.4.144 164.25.154.39 164.27.120.44 164.30.110.144 10.118.233.49 164.26.226.142 164.25.128.18 10.81.81.73 164.23.122.96 10.94.19.234 10.124.151.47 164.25.157.147 164.16.6.41 164.21.38.223 164.29.46.92 164.28.176.28 10.121.38.36 164.25.224.212 164.18.19.93 164.29.58.89 164.18.241.150 164.28.98.168 164.34.194.15 164.32.10.18 164.18.130.18 164.25.87.25 164.32.137.204 164.23.251.76 10.187.160.43 164.34.51.17 10.118.71.128 10.118.71.129 164.28.105.36 10.82.146.52 164.29.164.153 164.20.24.85 164.20.252.140 164.34.30.147 164.28.159.13 10.187.30.102 164.24.197.92 10.118.71.134 164.20.237.224 10.212.216.29 164.29.234.145 164.20.124.208 164.23.123.159 10.141.43.17 164.32.72.21 164.20.7.139 164.34.30.15 10.118.43.27 164.34.30.14 164.29.13.178 164.21.112.14 10.141.42.139 164.21.38.222 164.20.46.183 164.18.54.109 164.18.130.150 164.25.95.12 10.121.50.20 164.30.145.113 10.39.211.42 164.28.176.14 164.21.142.231 164.34.80.99 164.25.14.84 10.141.42.138 164.32.72.25 164.25.14.83 164.22.182.84 10.82.150.149 10.186.21.25 164.25.245.14 164.16.240.147 164.29.245.80 164.28.1.207 10.186.22.30 164.23.92.214 164.25.14.85 10.82.150.148 164.32.118.97 164.30.168.17 164.25.154.28 164.18.124.180 164.26.105.86 10.118.233.51 10.118.233.50 164.21.38.216 164.26.60.91 164.24.226.169 164.23.238.82 164.32.37.25 164.25.6.147 10.186.23.12 10.94.30.147
10.39.211.41 164.32.173.76 164.25.170.237 164.25.170.25 10.141.43.31 164.18.136.43 10.141.153.24 164.21.142.233 164.33.120.29 10.179.182.44 164.25.186.161 10.108.35.173 164.24.155.15 10.208.30.34 10.94.19.235 164.16.24.29 164.26.243.142 10.82.41.26 164.16.12.142 164.20.50.76 164.32.89.122 10.146.32.77 164.28.198.105 164.18.72.140 164.22.92.230 164.34.80.141 10.108.40.131 10.108.35.157 164.18.198.209 10.118.39.81 10.92.22.76 164.30.144.44 164.32.86.230 164.20.51.22 164.16.160.147 10.133.116.13 10.133.116.38 164.29.172.216 164.29.172.218 164.29.172.217 164.26.197.145 164.29.172.203 164.29.172.207 164.26.197.136 164.26.197.137 10.206.188.102 10.206.188.99 164.26.197.134 164.26.197.135 10.206.188.100 10.206.188.101 );

my $pageurl=$base."/firewall_order_ip_group/order_group";

foreach my $ip (@ipl){
   %form=();
   $form{'order_type_id'}="1";
   $form{'firewall_id'}="38";
   $form{'firewall_group1'}="68";
   $form{'ip_start1'}=$ip;
   $form{'ip_end1'}=$ip;
   
   my $req=POST($pageurl,Content_Type=>'form-data',Content=>[%form]);
   
   my $response=$ua->request($req);
   if ($response->code ne "200"){
      printf STDERR ("ERROR: fail to login as '%s'\n",$loginuser);
      print STDERR $response->code;
      print STDERR $response->content;
      exit(1);
   }
   my $page=$response->content();
   if ($page=~m/Ihre Bestellung wurde in iBest eingestellt/){
      printf("INFO:  Antrag für '%s' OK\n",$ip) if ($verbose);
   }
   else{
      printf STDERR ("ERROR:  Antrag für '%s' fail\n",$ip);
   }
}




